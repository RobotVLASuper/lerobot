<!DOCTYPE html>
<html>
<head>
    <title>Robot Observation Stream</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header Bar -->
    <div class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-lg">
        <div class="flex space-x-6">
            <div class="flex items-center space-x-2">
                <span class="text-gray-400">Mode:</span>
                <span id="control-phase" class="font-mono">-</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-gray-400">Episode:</span>
                <span id="episode-counter" class="font-mono">-</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-gray-400">Reward:</span>
                <span id="reward-display" class="font-mono bg-gray-700 px-2 py-1 rounded">-</span>
            </div>
        </div>
        <div id="timestamp" class="font-mono text-gray-400"></div>
    </div>
    
    <!-- Main Container -->
    <div class="container mx-auto p-6 flex flex-col lg:flex-row gap-6">
        <!-- Left Panel -->
        <div class="lg:w-2/3 space-y-6">
            <!-- Camera Grid -->
            <div id="cameras" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            
            <!-- Events Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Events</h3>
                <div id="events" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="lg:w-1/3 space-y-6">
            <!-- State Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Robot State</h3>
                <div id="state-values" class="space-y-2"></div>
            </div>
            
            <!-- Config Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Configuration</h3>
                <div id="config-values" class="space-y-2"></div>
            </div>
            
            <!-- Controls Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Controls</h3>
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">→</span>
                        <span>Exit Early</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">←</span>
                        <span>Rerecord</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">Esc</span>
                        <span>Stop</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">Space</span>
                        <span>Toggle Reward</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Connect to Socket.IO server
        const socket = io();
        let cameras = {};

        // Format timestamp
        function formatTimestamp(timestamp) {
            return new Date(timestamp * 1000).toISOString();
        }

        // Update state display
        function updateState(stateData) {
            const stateContainer = document.getElementById('state-values');
            stateContainer.innerHTML = '';
            
            for (const [key, value] of Object.entries(stateData)) {
                const stateElement = document.createElement('div');
                stateElement.className = 'font-mono text-sm';
                const formattedData = Array.isArray(value.data) ? 
                    value.data.map(v => v.toFixed(4)).join(', ') : 
                    value.data.toFixed(4);
                stateElement.textContent = `${key}: [${formattedData}]`;
                stateContainer.appendChild(stateElement);
            }
        }

        // Update config display
        function updateConfig(configData) {
            const configContainer = document.getElementById('config-values');
            configContainer.innerHTML = '';
            
            for (const [key, value] of Object.entries(configData)) {
                const configElement = document.createElement('div');
                configElement.className = 'font-mono text-sm';
                configElement.textContent = `${key}: ${value}`;
                configContainer.appendChild(configElement);
            }
            
            // Update header information
            document.getElementById('control-phase').textContent = configData.control_phase;
            document.getElementById('episode-counter').textContent = 
                `${configData.current_episode}/${configData.num_episodes}`;
        }

        // Update events display
        function updateEvents(eventsData) {
            const eventsContainer = document.getElementById('events');
            eventsContainer.innerHTML = '';
            
            for (const [key, value] of Object.entries(eventsData)) {
                const eventElement = document.createElement('div');
                eventElement.className = `p-2 rounded text-center font-mono text-sm ${
                    value ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'
                }`;
                eventElement.textContent = key.replace(/_/g, ' ');
                eventsContainer.appendChild(eventElement);
            }
            
            // Update reward display if present
            if ('next_reward' in eventsData) {
                document.getElementById('reward-display').textContent = 
                    eventsData.next_reward.toString();
            }
        }

        // Handle incoming observation updates
        socket.on('observation_update', function(data) {
            console.log('Received observation update:', data);
            
            // Update timestamp
            if (data.timestamp) {
                document.getElementById('timestamp').textContent = 
                    `Last Update: ${formatTimestamp(data.timestamp)}`;
            }
            
            // Update images
            if (data.images) {
                for (const [name, imageData] of Object.entries(data.images)) {
                    if (!cameras[name]) {
                        // Create new camera display
                        const container = document.createElement('div');
                        container.className = 'bg-white rounded-lg shadow-md p-4';
                        
                        const title = document.createElement('h3');
                        title.className = 'text-lg font-semibold mb-2 text-gray-700';
                        title.textContent = name;
                        
                        const canvas = document.createElement('canvas');
                        canvas.id = `canvas-${name}`;
                        canvas.className = 'w-full border border-gray-200 rounded';
                        
                        container.appendChild(title);
                        container.appendChild(canvas);
                        document.getElementById('cameras').appendChild(container);
                        cameras[name] = canvas;
                    }
                    
                    // Update image
                    const canvas = cameras[name];
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = 'data:image/jpeg;base64,' + imageData;
                }
            }
            
            // Update state values
            if (data.state) {
                updateState(data.state);
            }
            
            // Update config values
            if (data.config) {
                updateConfig(data.config);
            }
            
            // Update events
            if (data.events) {
                updateEvents(data.events);
            }
        });

        // Connection handling
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            
            // Clear the config display
            document.getElementById('control-phase').textContent = '-';
            document.getElementById('episode-counter').textContent = '-';
            document.getElementById('reward-display').textContent = '-';
            document.getElementById('timestamp').textContent = '';
            
            // Clear the panels
            document.getElementById('state-values').innerHTML = '';
            document.getElementById('config-values').innerHTML = '';
            document.getElementById('events').innerHTML = '';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
        });

        // Keyboard event handling for controls
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowRight':
                    console.log('Right arrow pressed - Exit Early');
                    socket.emit('keydown_event', { key: 'ArrowRight' });
                    break;
                case 'ArrowLeft':
                    console.log('Left arrow pressed - Rerecord');
                    socket.emit('keydown_event', { key: 'ArrowLeft' });
                    break;
                case 'Escape':
                    console.log('Escape pressed - Stop');
                    socket.emit('keydown_event', { key: 'Escape' });
                    break;
                case ' ':  // Space key
                    console.log('Space pressed - Toggle Reward');
                    socket.emit('keydown_event', { key: 'Space' });
                    break;
            }
        });
    </script>
</body>
</html>