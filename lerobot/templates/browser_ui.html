<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Robot Observation Stream (Alpine.js Refactor - Dark Theme)</title>
  
  <!-- Socket.IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body
  class="bg-gray-900 text-gray-200 min-h-screen"
  x-data="robotApp()"
  x-init="initSocket()"
  x-on:keydown.window.arrow-right="handleKey('ArrowRight')"
  x-on:keydown.window.arrow-left="handleKey('ArrowLeft')"
  x-on:keydown.window.escape="handleKey('Escape')"
  x-on:keydown.window.space.prevent="handleKey('Space')"
>

  <!-- Header Bar -->
  <div class="bg-gray-800 text-gray-200 p-4 flex justify-between items-center shadow-lg">
    <div class="flex space-x-6">
      <!-- Mode -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Mode:</span>
        <span class="font-mono" x-text="configData.control_phase ?? '-'">-</span>
      </div>
      <!-- Episode -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Episode:</span>
        <span
          class="font-mono"
          x-text="(configData.current_episode !== undefined && configData.num_episodes !== undefined)
                  ? (configData.current_episode + '/' + configData.num_episodes)
                  : '-'"
        >
          -
        </span>
      </div>
      <!-- Reward -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Reward:</span>
        <span
          class="font-mono bg-gray-700 px-2 py-1 rounded"
          x-text="eventsData.next_reward ?? '-'"
        >
          -
        </span>
      </div>
      <!-- Time Remaining -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Time Remaining:</span>
        <span
          class="font-mono bg-red-700 px-2 py-1 rounded"
          x-text="countdownText"
        >
          00:00
        </span>
      </div>
      <!-- Enable Voice Button -->
      <button
        id="enable-voice-button"
        class="font-mono bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700"
        x-on:click="enableVoice()"
      >
        Enable Voice
      </button>
    </div>
    <!-- Last Timestamp -->
    <div id="timestamp" class="font-mono text-gray-400" x-text="timestamp"></div>
  </div>
  
  <!-- Main Container -->
  <div class="container mx-auto p-6 flex flex-col lg:flex-row gap-6">
    <!-- Left Panel -->
    <div class="lg:w-2/3 space-y-6">
      <!-- Camera Grid -->
      <div
        id="cameras"
        class="grid grid-cols-1 md:grid-cols-2 gap-4"
      >
        <!-- Loop over images object -->
        <template x-for="(imageData, name) in images" :key="name">
          <div class="bg-gray-800 rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold mb-2 text-gray-300" x-text="name"></h3>
            <!-- For simplicity, using an <img> tag. If you must use <canvas>, see the note below. -->
            <img
              class="w-full border border-gray-700 rounded"
              :src="`data:image/jpeg;base64,${imageData}`"
              alt=""
            />
          </div>
        </template>
      </div>
      
      <!-- Events Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Events</h3>
        <div id="events" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
          <template x-for="(value, key) in eventsData" :key="key">
            <div
              class="p-2 rounded text-center font-mono text-sm"
              :class="value
                ? 'bg-green-600 text-white'
                : 'bg-gray-600 text-gray-300'"
              x-text="key.replaceAll('_',' ')"
            ></div>
          </template>
        </div>
      </div>
    </div>
    
    <!-- Right Panel -->
    <div class="lg:w-1/3 space-y-6">
      <!-- State Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Robot State</h3>
        <div id="state-values" class="space-y-2">
          <template x-for="(valObj, key) in stateData" :key="key">
            <div class="font-mono text-sm">
              <!-- Arrays -->
              <template x-if="Array.isArray(valObj.data)">
                <span
                  x-text="`${key}: [${valObj.data.map(v => v.toFixed(4)).join(', ')}]`"
                ></span>
              </template>
              <!-- Single values -->
              <template x-if="!Array.isArray(valObj.data)">
                <span x-text="`${key}: [${valObj.data.toFixed(4)}]`"></span>
              </template>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Config Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Configuration</h3>
        <div id="config-values" class="space-y-2">
          <template x-for="(value, key) in configData" :key="key">
            <div class="font-mono text-sm">
              <span x-text="`${key}: ${value}`"></span>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Controls Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Controls</h3>
        <div class="space-y-4">
          <!-- Exit Early -->
          <div class="flex items-center space-x-3">
            <span class="font-mono bg-gray-600 px-2 py-1 rounded text-sm">→</span>
            <span>Exit Early</span>
            <button
              class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600"
              x-on:click="handleKey('ArrowRight')"
            >
              Exit Early
            </button>
          </div>
          <!-- Rerecord -->
          <div class="flex items-center space-x-3">
            <span class="font-mono bg-gray-600 px-2 py-1 rounded text-sm">←</span>
            <span>Rerecord</span>
            <button
              class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600"
              x-on:click="handleKey('ArrowLeft')"
            >
              Rerecord
            </button>
          </div>
          <!-- Stop -->
          <div class="flex items-center space-x-3">
            <span class="font-mono bg-gray-600 px-2 py-1 rounded text-sm">Esc</span>
            <span>Stop</span>
            <button
              class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600"
              x-on:click="handleKey('Escape')"
            >
              Stop
            </button>
          </div>
          <!-- Toggle Reward -->
          <div class="flex items-center space-x-3">
            <span class="font-mono bg-gray-600 px-2 py-1 rounded text-sm">Space</span>
            <span>Toggle Reward</span>
            <button
              class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600"
              x-on:click="handleKey('Space')"
            >
              Toggle Reward
            </button>
          </div>
        </div>
      </div>

      <!-- Log Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Logs</h3>
        <div id="log-items" class="space-y-2">
          <template x-for="(log, idx) in logs" :key="idx">
            <div class="font-mono text-sm" x-text="log"></div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('robotApp', () => ({
        // Reactive state
        configData: {},
        stateData: {},
        eventsData: {},
        logs: [],
        images: {},
        countdownTime: 0,
        timestamp: '',
        
        // Computed-like property for displaying the countdown
        get countdownText() {
          const minutes = Math.floor(this.countdownTime / 60);
          const secs = Math.floor(this.countdownTime % 60);
          return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        },

        initSocket() {
            this.socket = io({
                reconnection: true,
                reconnectionAttempts: Infinity,      // Unlimited reconnection attempts
                reconnectionDelay: 1000,             // Start with 1 second delay
                reconnectionDelayMax: 5000,          // Max delay of 5 seconds
                randomizationFactor: 0.5
            });

          this.socket.on('connect', () => {
            console.log('Connected to server');
          });
          this.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            this.resetData();
          });
          this.socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
          });

          this.socket.on('observation_update', (data) => {
            if (data.timestamp) {
              this.timestamp = `Last Update: ${this.formatTimestamp(data.timestamp)}`;
            }
            if (data.config) {
              this.updateConfig(data.config);
            }
            if (data.state) {
              this.stateData = data.state;
            }
            if (data.events) {
              this.eventsData = data.events;
            }
            if (data.log_items) {
              this.logs = data.log_items;
            }
            if (data.images) {
              this.images = data.images;
            }
            if (data.countdown_time !== undefined) {
              this.countdownTime = data.countdown_time;
            }
          });

          this.socket.on('config_update', (data) => {
            if (data.config) {
              this.updateConfig(data.config);
            }
            if (data.timestamp) {
              this.timestamp = `Config Updated: ${this.formatTimestamp(data.timestamp)}`;
            }
            if (data.countdown_time !== undefined) {
              this.countdownTime = data.countdown_time;
            }
          });

          this.socket.on('log_say', (data) => {
            this.speakMessage(data.message);
          });
        },

        // Merge config data
        updateConfig(newConfig) {
          this.configData = { ...this.configData, ...newConfig };
        },

        // Handle special keys
        handleKey(key) {
          console.log(`${key} pressed.`);
          // Forward the key event to the server
          this.socket.emit('keydown_event', { key });
        },

        // Reset the UI upon disconnect
        resetData() {
          this.configData = {};
          this.stateData = {};
          this.eventsData = {};
          this.logs = [];
          this.images = {};
          this.countdownTime = 0;
          this.timestamp = '';
        },

        formatTimestamp(tsSeconds) {
          return new Date(tsSeconds * 1000).toISOString();
        },

        enableVoice() {
          this.loadVoices().then(() => {
            this.speakMessage('Voice is now enabled!');
          });
        },

        loadVoices() {
          return new Promise((resolve) => {
            let voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
              resolve(voices);
            } else {
              speechSynthesis.onvoiceschanged = () => {
                voices = speechSynthesis.getVoices();
                resolve(voices);
              };
            }
          });
        },

        speakMessage(message) {
          const utterance = new SpeechSynthesisUtterance(message);
          speechSynthesis.speak(utterance);
        },
      }));
    });
  </script>
</body>
</html>
